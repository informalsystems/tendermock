# Tendermock

Testing ABCI and ABCI++ by mocking Tendermint.

## Installing Tendermock

To install Tendermock, first, make sure you have a compatible version of python (e.g. 3.10).
You can install python requirements by running

```
pip install -r requirements.txt
```

Or if you are using `poetry`.

```
poetry init -n
cat requirements.txt | xargs poetry add
source $(poetry env info -p)/bin/activate
```

## Regenerating protobuf code (optional)

You can skip this section if you cloned the repository from GitHub - it should include the generated code already.

The code was generated by running, in https://github.com/tendermint/tendermint/tree/0.35x/proto, the command:

```
python3 -m grpc_tools.protoc -I. -I../third_party/proto --python_out=../../tendermock/src/proto --grpc_python_out=../../tendermock/src/proto $(find . -iname "*.proto")
```

To run this, [grpc_tools](https://grpc.io/docs/languages/python/quickstart/) need to be installed

## Preparing the docker image

Build the image with the tag `simd_abci`.

```
docker build -t simd_abci .
```

Copy the genesis file from the built image for `tendermock.py`.

```
docker run --rm --entrypoint cat simd_abci .simapp/config/genesis.json > genesis.json
```

## Play with Tendermock

Run each command in separate terminals and keep them running.

Start the ABCI app

```
docker run \
--add-host=host.docker.internal:host-gateway \
--name simapp \
-ti \
-p 26658:26658 \
-p 26656:26656 \
-p 9091:9091 \
-p 1317:1317 \
-p 9090:9090 \
--rm \
simd_abci \
simd start --transport=grpc --with-tendermint=false --grpc-only --rpc.laddr=tcp://host.docker.internal:99999
```

Start Tendermock and connect to ABCI ports

```
python src/tendermock.py genesis.json --tendermock-host 0.0.0.0 --tendermock-port 26657 --app-host localhost --app-port 26658
```

Run a simple client executing bank transfer on the Tendermock ABCI app.

```
python pipeline_poc/tendermock_client.py
```
